@page "/documents/details/{Id:int}"
@* @rendermode InteractiveWebAssembly *@
@using CWDocMgrBlazor.Client.Models
@using SharedLib.DTOs
@using SharedLib.Models
@using SharedLib.ViewModels
@inject HttpClient Http


@if (document == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <h4>Document: @document.OriginalDocumentName</h4>
    <div class="d-flex flex-row mb-6">
        <div class="d-flex flex-column mb-6" style="border: 1px solid #ccc; padding: 10px; border-radius: 4px;">
            <div class="p-1">
                <strong>Date:</strong> @document.DocumentDate.ToString("yyyy-MM-dd")
            </div>
            <div class="p-1">
                <strong>User Name:</strong> @document.UserName
            </div>
        </div>
        <div class="d-flex flex-column mb-6" style="border: 1px solid #ccc; padding: 10px; border-radius: 4px;">
            <button @ref="ocrButton"
                    id="OcrButton"
                    class="btn btn-primary mb-2"
                    @onclick="DoOcr"
                    disabled="@isOcrRunning">
                @(isOcrRunning ? "OCR (working...)" : "OCR")
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(document.OCRText))
    {
        <div class="ocr-container">
            <h5>OCR Text:</h5>
            <pre class="ocr-text">@document.OCRText</pre>
        </div>
    }


    @if (!string.IsNullOrEmpty(document.DocumentName) && document.DocumentName.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
    {
        <div class="mt-3">
            <h5>PDF Document:</h5>
            <object data="@document.FileContent" type="application/pdf" width="100%" height="800">
                <a href="@document.FileContent" target="_blank" rel="noopener">Open PDF in a new tab</a>
            </object>
        </div>
    }
    else if (!string.IsNullOrEmpty(document.FileContent))
    {
        <img src="@document.FileContent" alt="Document Image" style="width:100%; max-height:auto;" />
    }
    else
    {
        <p><em>No image available.</em></p>
    }
}

@code {
    [Parameter] public int Id { get; set; }
    private DocumentDetailsVM? document;

    private ElementReference ocrButton; // Reference to the OCR button
    private bool isOcrRunning;          // Drive UI state instead of manipulating the DOM


    protected override async Task OnInitializedAsync()
    {
        document = await Http.GetFromJsonAsync<DocumentDetailsVM>($"api/documents/{Id}");
    }

    private async Task DoOcr()
    {
        isOcrRunning = true;
        StateHasChanged();

        try
        {
            var ocrRequest = new OCRRequestDto { Id = Id };

            var response = await Http.PostAsJsonAsync("api/documents/ocrdocument", ocrRequest);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<OcrResponse>();
                if (result != null)
                {
                    document.OCRText = result.ocrText;
                    StateHasChanged();
                }
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                Console.Error.WriteLine($"OCR processing failed: {errorMessage}");
                // Optionally display an error message to the user
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error in OCR processing: {ex.Message}");
            // Optionally display an error message to the user
        }
        finally
        {
            isOcrRunning = false;
            StateHasChanged();
        }
    }
}
